<!DOCTYPE html>
<html>
<head>
    <title>Topic Summary Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0 1rem;
        }

        h1, h2 {
            text-align: center;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-width: 600px;
            margin: 2rem auto;
        }

        label {
            font-weight: bold;
        }

        input[type="text"], button {
            padding: 0.5rem;
            font-family: Arial, sans-serif;
            font-size: 1rem;
        }

        input[type="text"] {
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }

        #output_content {
            white-space: pre-wrap;
            background-color: #f5f5f5;
            padding: 1rem;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
    </style>
    <script>
        // Use the standalone webhook relay service
        const RELAY_WS_URL = 'wss://anyquest-webhook-relay-production-863f.up.railway.app';
        let currentWebSocket = null;

        // Handle form submission
        async function handleFormSubmit(event) {
            event.preventDefault();

            const topicInput = document.getElementById('topicInput');
            const output = document.getElementById('output');
            const output_content = document.getElementById('output_content');
            const output_id = document.getElementById('output_id');

            // Show loading state
            output.textContent = 'Submitting topic...';
            output_content.textContent = 'Waiting for LLM response...';
            output_id.textContent = '';

            try {
                // Submit the topic and get the webhook ID back
                const response = await fetch('/submit-topic', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ topic: topicInput.value }),
                });

                const result = await response.json();
                const webhookId = result.webhookId;

                output.textContent = 'Form Submission: ' + result.message;
                output_id.textContent = 'Webhook ID: ' + webhookId;
                console.log('Job ID:', result.jobId);

                // Close existing WebSocket if any
                if (currentWebSocket) {
                    currentWebSocket.close();
                }

                // Connect to relay WebSocket with the webhook ID
                const wsUrl = `${RELAY_WS_URL}/ws?id=${webhookId}`;
                console.log('Connecting to WebSocket:', wsUrl);
                currentWebSocket = new WebSocket(wsUrl);

                currentWebSocket.onopen = () => {
                    console.log('WebSocket connected for webhook ID:', webhookId);
                    output.textContent = 'Connected! Waiting for LLM response...';
                };

                currentWebSocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    output.textContent = 'WebSocket connection error';
                };

                currentWebSocket.onclose = () => {
                    console.log('WebSocket disconnected');
                };

                currentWebSocket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    console.log('Received webhook response:', data);

                    output_id.textContent = 'Request ID: ' + data.id;
                    output_content.textContent = data.content;
                    output.textContent = 'Response received!';
                };

            } catch (error) {
                console.error('Error submitting form:', error);
                output.textContent = 'Error: An error occurred while submitting the topic.';
                output_content.textContent = '';
            }

            // Clear the form
            topicInput.value = '';
        }
    </script>
</head>
<body>
<h1>Topic Summary Generator</h1>
<p style="text-align: center; color: #666;">Enter a topic and receive an AI-generated summary</p>

<form id="topicForm" onsubmit="handleFormSubmit(event)">
    <label for="topicInput">Topic:</label>
    <input type="text" id="topicInput" name="topic" placeholder="e.g., Quantum Computing, Climate Change, etc." required>
    <button type="submit">Generate Summary</button>
</form>

<h2>Response</h2>
<p id="output"></p>
<p id="output_id" style="color: #666; font-size: 0.9rem;"></p>
<pre id="output_content"></pre>
</body>
</html>
