<!DOCTYPE html>
<html>
<head>
    <title>AnyQuest Agent Portal</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 2rem;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .admin-link {
            text-align: center;
            margin-bottom: 2rem;
        }

        .admin-link a {
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
        }

        .admin-link a:hover {
            text-decoration: underline;
        }

        .agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .agent-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .agent-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .agent-card.selected {
            border: 2px solid #007bff;
            box-shadow: 0 4px 8px rgba(0,123,255,0.2);
        }

        .agent-card h3 {
            margin-top: 0;
            color: #007bff;
        }

        .agent-card p {
            color: #666;
            margin: 0.5rem 0;
        }

        .form-container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }

        .form-container.active {
            display: block;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        label {
            font-weight: bold;
            margin-bottom: 0.25rem;
            display: block;
        }

        input[type="text"], textarea, input[type="file"] {
            padding: 0.5rem;
            font-family: Arial, sans-serif;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        button {
            padding: 0.75rem 1.5rem;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .back-button {
            background-color: #6c757d;
            margin-bottom: 1rem;
        }

        .back-button:hover {
            background-color: #5a6268;
        }

        #response {
            margin-top: 2rem;
            padding: 1.5rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }

        #response.active {
            display: block;
        }

        #response h2 {
            margin-top: 0;
            color: #333;
        }

        #output {
            padding: 1rem;
            background-color: #e7f3ff;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        #output_id {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        #output_content {
            white-space: pre-wrap;
            background-color: #f5f5f5;
            padding: 1rem;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AnyQuest Agent Portal</h1>

        <div class="admin-link">
            <a href="/admin">⚙️ Manage Agents</a>
        </div>

        <div id="agentSelection">
            <h2 style="text-align: center; color: #666;">Select an Agent</h2>
            <div class="agents-grid" id="agentsGrid">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading agents...</p>
                </div>
            </div>
        </div>

        <div class="form-container" id="formContainer">
            <button class="back-button" onclick="backToAgentSelection()">← Back to Agent Selection</button>
            <h2 id="formTitle"></h2>
            <p id="formDescription" style="color: #666;"></p>
            <form id="agentForm"></form>
        </div>

        <div id="response">
            <h2>Response</h2>
            <div id="output"></div>
            <p id="output_id"></p>
            <pre id="output_content"></pre>
        </div>
    </div>

    <script>
        const RELAY_WS_URL = 'wss://anyquest-webhook-relay-production-863f.up.railway.app';
        let currentWebSocket = null;
        let selectedAgent = null;
        let availableAgents = {};

        // Load available agents
        async function loadAgents() {
            try {
                const response = await fetch('/agents');
                const data = await response.json();
                availableAgents = data.agents;

                const grid = document.getElementById('agentsGrid');
                grid.innerHTML = '';

                if (Object.keys(availableAgents).length === 0) {
                    grid.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1/-1;">No agents configured. <a href="/admin">Add one in the admin panel</a>.</p>';
                    return;
                }

                for (const [agentId, agent] of Object.entries(availableAgents)) {
                    const card = document.createElement('div');
                    card.className = 'agent-card';
                    card.innerHTML = `
                        <h3>${agent.name}</h3>
                        <p>${agent.description || 'No description available'}</p>
                        <p style="font-size: 0.9rem; color: #999;">${agent.fields.length} field(s)</p>
                    `;
                    card.onclick = () => selectAgent(agentId);
                    grid.appendChild(card);
                }
            } catch (error) {
                console.error('Error loading agents:', error);
                document.getElementById('agentsGrid').innerHTML = '<p style="color: red; grid-column: 1/-1;">Error loading agents: ' + error.message + '</p>';
            }
        }

        // Select an agent and show its form
        function selectAgent(agentId) {
            selectedAgent = agentId;
            const agent = availableAgents[agentId];

            document.getElementById('agentSelection').style.display = 'none';
            document.getElementById('formContainer').classList.add('active');
            document.getElementById('formTitle').textContent = agent.name;
            document.getElementById('formDescription').textContent = agent.description || '';

            // Build dynamic form
            const form = document.getElementById('agentForm');
            form.innerHTML = '';

            agent.fields.forEach(field => {
                const fieldDiv = document.createElement('div');

                const label = document.createElement('label');
                label.textContent = field.label + (field.required ? ' *' : '');
                label.setAttribute('for', field.name);
                fieldDiv.appendChild(label);

                let input;
                if (field.type === 'textarea') {
                    input = document.createElement('textarea');
                    input.placeholder = field.placeholder || '';
                } else if (field.type === 'file') {
                    input = document.createElement('input');
                    input.type = 'file';
                    if (field.multiple) {
                        input.multiple = true;
                    }
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.placeholder = field.placeholder || '';
                }

                input.name = field.name;
                input.id = field.name;
                input.required = field.required;

                fieldDiv.appendChild(input);
                form.appendChild(fieldDiv);
            });

            // Add submit button
            const submitButton = document.createElement('button');
            submitButton.type = 'submit';
            submitButton.textContent = 'Submit';
            form.appendChild(submitButton);

            // Handle form submission
            form.onsubmit = handleFormSubmit;
        }

        // Go back to agent selection
        function backToAgentSelection() {
            document.getElementById('agentSelection').style.display = 'block';
            document.getElementById('formContainer').classList.remove('active');
            document.getElementById('response').classList.remove('active');
            selectedAgent = null;

            if (currentWebSocket) {
                currentWebSocket.close();
            }
        }

        // Handle form submission
        async function handleFormSubmit(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            formData.append('agentId', selectedAgent);

            const output = document.getElementById('output');
            const outputContent = document.getElementById('output_content');
            const outputId = document.getElementById('output_id');
            const responseDiv = document.getElementById('response');

            // Show response section and loading state
            responseDiv.classList.add('active');
            output.textContent = 'Submitting...';
            outputContent.textContent = 'Waiting for response...';
            outputId.textContent = '';

            // Disable submit button
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';

            try {
                // Submit the form
                const response = await fetch('/submit', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Submission failed');
                }

                const webhookId = result.webhookId;
                output.textContent = 'Form Submission: ' + result.message;
                outputId.textContent = 'Webhook ID: ' + webhookId;
                console.log('Job ID:', result.jobId);

                // Close existing WebSocket if any
                if (currentWebSocket) {
                    currentWebSocket.close();
                }

                // Connect to relay WebSocket with the webhook ID
                const wsUrl = `${RELAY_WS_URL}/ws?id=${webhookId}`;
                console.log('Connecting to WebSocket:', wsUrl);
                currentWebSocket = new WebSocket(wsUrl);

                currentWebSocket.onopen = () => {
                    console.log('WebSocket connected for webhook ID:', webhookId);
                    output.textContent = 'Connected! Waiting for response...';
                };

                currentWebSocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    output.textContent = 'WebSocket connection error';
                    submitButton.disabled = false;
                    submitButton.textContent = 'Submit';
                };

                currentWebSocket.onclose = () => {
                    console.log('WebSocket disconnected');
                    submitButton.disabled = false;
                    submitButton.textContent = 'Submit';
                };

                currentWebSocket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    console.log('Received webhook response:', data);

                    outputId.textContent = 'Request ID: ' + data.id;
                    outputContent.textContent = data.content;
                    output.textContent = 'Response received!';

                    submitButton.disabled = false;
                    submitButton.textContent = 'Submit';
                };

            } catch (error) {
                console.error('Error submitting form:', error);
                output.textContent = 'Error: ' + error.message;
                outputContent.textContent = '';
                submitButton.disabled = false;
                submitButton.textContent = 'Submit';
            }
        }

        // Load agents on page load
        window.addEventListener('DOMContentLoaded', loadAgents);
    </script>
</body>
</html>
